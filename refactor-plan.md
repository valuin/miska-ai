# Refactoring Plan: From Chain-of-Thought Hook to Integrated Tool-Calling

This document outlines the plan to replace the existing Chain-of-Thought (CoT) implementation with a more robust and integrated tool-calling approach for generating task plans.

## 1. Backend Changes

### 1.1. Create `mastra/tools/cot-tool.ts`

- **Objective:** Create a new Mastra tool that will be responsible for generating a structured plan of "todos".
- **File:** `mastra/tools/cot-tool.ts`
- **Tool Name:** `planTodosTool`
- **Input Schema:** `z.object({ task: z.string() })`
- **Output Schema:** `z.object({ todos: z.array(z.object({ title: z.string(), reasoning: z.string() })) })`
- **Implementation:**
  - The `execute` function will use a lightweight model (e.g., `TINY_MODEL`) to generate the plan. This ensures the planning step is quick and doesn't interfere with the main agent's thinking process.
  - The tool will be self-contained and exportable.

### 1.2. Integrate `planTodosTool` into Mastra Agents

- **Objective:** Add the new `planTodosTool` to the relevant agents so they can use it to create a plan before executing a task.
- **Target Agent (for this example):** `mastra/agents/accounting-agent.ts`
- **Changes:**
  - Import `planTodosTool` into `mastra/agents/accounting-agent.ts`.
  - Add `planTodosTool` to the `tools` object within the `accountingAgent` definition.
  - Update the agent's `instructions` to explicitly guide the AI to use `planTodosTool` at the beginning of a complex task to outline its steps.

## 2. Deprecation of Old CoT Implementation

### 2.1. Remove CoT Hook

- **Objective:** Delete the `useChainOfThought` hook as it will no longer be needed.
- **Action:** Delete the file `hooks/useChainOfThought.ts`.

### 2.2. Remove CoT API Endpoint

- **Objective:** Remove the dedicated API endpoint for the old CoT stream.
- **Action:** Delete the directory `app/(chat)/api/chain-of-thought-stream` and all its contents.

## 3. Frontend Changes

### 3.1. Refactor `components/chat.tsx`

- **Objective:** Remove all logic related to the old `useChainOfThought` hook and simplify the submission logic.
- **Changes:**
  - Remove the `useChainOfThought` hook import and its usage.
  - Delete all state variables associated with the old CoT (`cotResponse`, `cotLoading`, `cotError`, `cotFinalAnswer`).
  - Remove the `handleOrchestratedSubmit` function and revert to using the original `handleSubmit` from `@ai-sdk/react`.
  - Delete the logic in `experimental_prepareRequestBody` that prepends the `cotFinalAnswer` to the message list.
  - Remove any UI elements that were conditionally rendered based on CoT state.

### 3.2. Create a Component to Render the Plan

- **Objective:** Create a dedicated React component to display the structured "todos" generated by `planTodosTool`.
- **File:** `components/plan-display.tsx` (new file)
- **Props:** It will take the tool call/result data as a prop.
- **Functionality:**
  - It will parse the JSON output from the `planTodosTool`.
  - It will render the `title` and `reasoning` for each todo in a clean, readable format (e.g., a checklist or a list of cards).
  - This component will be used within the main message rendering logic.

### 3.3. Update Message Rendering Logic

- **Objective:** Integrate the new `PlanDisplay` component into the chat interface.
- **Target File:** `components/messages.tsx` (or wherever individual messages are rendered)
- **Changes:**
  - In the message rendering loop, check if a message is from the assistant and contains a tool call to `planTodosTool`.
  - If it does, render the `PlanDisplay` component with the tool call data instead of the default text content.

## 4. Streaming and Data Flow Verification

### 4.1. Review `lib/ai/mastra-integration.ts`

- **Objective:** Ensure that the existing data stream and tool-calling logic correctly handle the new `planTodosTool`.
- **Verification:**
  - Confirm that tool calls and their results are streamed correctly to the frontend.
  - The Vercel AI SDK should handle the streaming of tool-related annotations. No major changes are anticipated here, but it's important to verify.

This plan provides a clear roadmap for the refactoring. Once this plan is approved, I will proceed with the implementation.